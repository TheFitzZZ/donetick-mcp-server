services:
  donetick-mcp:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: donetick-mcp-server
    image: donetick-mcp-server:latest

    # Environment variables (REQUIRED: DONETICK_BASE_URL, DONETICK_USERNAME, DONETICK_PASSWORD)
    environment:
      - DONETICK_BASE_URL=${DONETICK_BASE_URL}
      - DONETICK_USERNAME=${DONETICK_USERNAME}
      - DONETICK_PASSWORD=${DONETICK_PASSWORD}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - RATE_LIMIT_PER_SECOND=${RATE_LIMIT_PER_SECOND:-10.0}
      - RATE_LIMIT_BURST=${RATE_LIMIT_BURST:-10}
      # Transport: "stdio" (default) or "sse"
      - MCP_TRANSPORT=${MCP_TRANSPORT:-sse}
      - SSE_HOST=${SSE_HOST:-0.0.0.0}
      - SSE_PORT=${SSE_PORT:-3000}

    # SSE transport port mapping
    ports:
      - "${SSE_PORT:-3000}:${SSE_PORT:-3000}"

    # Resource limits (recommended for production)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Restart policy
    restart: unless-stopped

    # Health check for SSE mode
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:3000/health').raise_for_status()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Security options
    security_opt:
      - no-new-privileges:true
